name: Spin up Vercel App

inputs:
  vercel-token:
    required: true
  vercel-project-id:
    required: true
  vercel-org-id:
    required: true
  PINECONE_API_KEY:
    required: true
  PINECONE_INDEX:
    required: true
  PINECONE_CLOUD:
    required: true
  PINECONE_REGION:
    required: true
  OPENAI_API_KEY:
    required: true

runs:
  using: 'composite'
  steps:
    - name: Check out current repository (pinecone-ts-client)
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '18.20.3'

    - name: Build pinecone-ts-client code
      run: npm install && npm run build
      shell: bash

    - name: Package pinecone-ts-client code
      run: npm pack
      shell: bash

    - name: Clone Vercel app
      uses: GuillaumeFalourd/clone-github-repo-action@main
      with:
        owner: 'pinecone-io'
        repository: 'pinecone-rag-demo'
        branch: 'main'

    - name: Move package to pinecone-rag-demo
      run: cd pinecone-rag-demo && mv ../pinecone-database-pinecone-*.tgz .
      shell: bash

#    - name: Install Pinecone Vercel app dependencies
#      run: cd pinecone-rag-demo && npm install
#      shell: bash

#    - name: Install pinecone-ts-client "main" branch code into the Vercel app
#      run: cd pinecone-rag-demo && npm install pinecone-database-pinecone-*.tgz
#      shell: bash
#
#    - name: Install pnpm
#      run: cd pinecone-rag-demo && npm install -g pnpm
#      shell: bash

#    - name: Install rag app dependencies with pnpm
#      run: cd pinecone-rag-demo && pnpm install
#      shell: bash

#    - name: Remove linting temporarily
#      run: cd pinecone-rag-demo && rm -rf .eslintrc.json
#      shell: bash

#    - name: Add Global Bin dir needed for pnmp
#      uses: pnpm/action-setup@v4
#      with:
#        version: 9
#      run: cd pinecone-rag-demo && pnpm setup
#      shell: bash

#    - name: Build Pinecone Vercel app
#      run: cd pinecone-rag-demo && pnpm run build
#      shell: bash

    - name: Install rag-demo deps
      run: cd pinecone-rag-demo && npm install
      shell: bash

    - name: Install pinecone-ts-client "main" branch code into the Vercel app
      run: cd pinecone-rag-demo && npm install pinecone-database-pinecone-*.tgz
      shell: bash

    - name: Install Vercel CLI
      run: cd pinecone-rag-demo && npm install vercel
      shell: bash

#    - name: Log into Vercel
#      env:
#        vercel-token: ${{ inputs.vercel-token }}
#        vercel-project-id: ${{ inputs.vercel-project-id }}
#        vercel-org-id: ${{ inputs.vercel-org-id }}
#      run: vercel login --token=${{ inputs.vercel-token }}
#      shell: bash

#    - name: Ensure you are in the pinecone-io scope
#      env:
#        vercel-token: ${{ inputs.vercel-token }}
#        vercel-project-id: ${{ inputs.vercel-project-id }}
#        vercel-org-id: ${{ inputs.vercel-org-id }}
#      run: cd pinecone-rag-demo && vercel switch pinecone-io  --scope=pinecone-io
#      shell: bash
#    - name: Try next-build instead of vercel-build
#      run: cd pinecone-rag-demo && pnpm run build
#      env:
#        PINECONE_API_KEY: ${{ inputs.PINECONE_API_KEY }}
#        PINECONE_REGION: us-west-2
#        PINECONE_INDEX: end-to-end-edge-test
#        PINECONE_CLOUD: aws
#        OPENAI_API_KEY: ${{ inputs.OPENAI_API_KEY }}
#      shell: bash

#    - name: Pull Vercel Environment Information
#      run: cd pinecone-rag-demo && vercel pull --yes --token=${{ inputs.vercel-token }} --scope=pinecone-io
#      shell: bash

#    - name: Build Project Artifacts
#      env:
#        vercel-token: ${{ inputs.vercel-token }}
#        vercel-project-id: ${{ inputs.vercel-project-id }}
#        vercel-org-id: ${{ inputs.vercel-org-id }}
#      run: |
#        cd pinecone-rag-demo
#        rm -f .eslintrc.json
#        vercel build --token=${{ inputs.vercel-token }} --scope=pinecone-io
#      shell: bash

    - name: Deploy Project Artifacts to Vercel
      env:
        vercel-token: ${{ inputs.vercel-token }}
        vercel-project-id: ${{ inputs.vercel-project-id }}
        vercel-org-id: ${{ inputs.vercel-org-id }}
        PINECONE_API_KEY: ${{ inputs.PINECONE_API_KEY }}
        PINECONE_REGION: ${{ PINECONE_REGION }}
        PINECONE_INDEX: ${{ inputs.PINECONE_INDEX }}
        PINECONE_CLOUD: ${{ inputs.PINECONE_CLOUD }}
        OPENAI_API_KEY: ${{ inputs.OPENAI_API_KEY }}
      run: cd pinecone-rag-demo && vercel --token=${{ inputs.vercel-token }} --scope=pinecone-io
      shell: bash

